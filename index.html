<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Collection Manager</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Card Collection Manager</h1>
            <p>Manage your card collection with ease</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="showTab('welcome')">Welcome</button>
            <button class="tab-button" onclick="showTab('collection')">Card Collection</button>
            <button class="tab-button" onclick="showTab('create')">Create Card Collection</button>
        </div>

        <!-- Welcome Tab -->
        <div id="welcome" class="tab-content active">
            <div class="welcome-tab">
                <h2>Card Grid Layout</h2>
                <p>Organize your cards in a grid layout. Click on any grid cell to assign cards from your loaded collection.</p>
                
                <!-- 1. Collection Status -->
                <div class="collection-status" id="collectionStatus" style="margin-bottom: 20px; padding: 15px; border-radius: 8px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                    <strong>Collection Status:</strong> <span id="statusText">No collection loaded</span>
                    <br><small>Go to the "Card Collection" tab to load your card collection file (.json)</small>
                </div>
                
                <div class="grid-controls" style="margin-bottom: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="exportGridConfig()" style="margin-right: 10px;">Save Grid Configuration</button>
                    <button class="btn btn-secondary" onclick="loadGridConfig()" style="margin-right: 10px;">Load Grid Configuration</button>
                    <button class="btn btn-warning" onclick="clearFilterMemory()" title="Clear saved filter preferences">Clear Filter Memory</button>
                </div>
                
                <!-- 2. Initial Card Grid -->
                <div class="grid-section">
                    <h3>Initial Card Grid</h3>
                    <p>Select cards and assign IDs (1-15) to each position</p>
                    <div class="card-grid" id="initialCardGrid">
                        <!-- 3x5 grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- 3. Attribute Planner -->
                <div class="grid-section">
                    <h3>Attribute Planner</h3>
                    <p>Plan which attribute to assign to each ID (1-15)</p>
                    <div class="attribute-planner" id="attributePlanner">
                        <!-- 1x15 grid will be generated by JavaScript -->
                    </div>
                </div>
                
                <!-- 4. New Card Grid -->
                <div class="grid-section">
                    <h3>New Card Grid</h3>
                    <p>Shows cards with their assigned IDs and planned attributes</p>
                    <div class="card-grid" id="newCardGrid">
                        <!-- 3x5 grid will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Card Collection Tab -->
        <div id="collection" class="tab-content">
            <h2>Card Collection</h2>
            
            <div class="load-section">
                <h3>Load Your Card Collection</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="collectionFile" class="file-input" accept=".json">
                    <button class="btn btn-primary" onclick="loadCollection()">Load Collection</button>
                </div>
            </div>

            <div class="filters-section">
                <h3>Current Card Collection</h3>
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="attributeFilter">Attribute:</label>
                        <select id="attributeFilter" onchange="filterCards()">
                            <option value="">All Attributes</option>
                            <option value="Logic">üîπ Logic</option>
                            <option value="Empathy">‚ù§Ô∏è Empathy</option>
                            <option value="Intuition">üå≤ Intuition</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="searchFilter">Search by Name:</label>
                        <input type="text" id="searchFilter" placeholder="Enter card name..." oninput="filterCards()">
                    </div>
                </div>
            </div>

            <div id="collectionCards" class="cards-grid">
                <div class="no-cards-message">No cards loaded. Please load a collection file first.</div>
            </div>
        </div>

        <!-- Create Card Collection Tab -->
        <div id="create" class="tab-content">
            <h2>Create Card Collection</h2>
            
            <div class="create-collection-section">
                <h3>Your Selected Cards</h3>
                <div id="selectedCards" class="cards-grid">
                    <div class="no-cards-message">No cards selected yet. Click the + button on cards to add them to your collection.</div>
                </div>
                <button class="btn btn-success" onclick="downloadCollection()" style="margin-top: 20px;">Create Card Collection</button>
            </div>

            <div class="filters-section">
                <h3>Search Cards</h3>
                <div class="filters-row">
                    <div class="filter-group">
                        <label for="createAttributeFilter">Attribute:</label>
                        <select id="createAttributeFilter" onchange="filterCreateCards()">
                            <option value="">All Attributes</option>
                            <option value="Logic">üîπ Logic</option>
                            <option value="Empathy">‚ù§Ô∏è Empathy</option>
                            <option value="Intuition">üå≤ Intuition</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="createSearchFilter">Search by Name:</label>
                        <input type="text" id="createSearchFilter" placeholder="Enter card name..." oninput="filterCreateCards()">
                    </div>
                </div>
            </div>

            <div id="createCards" class="cards-grid">
                <div class="no-cards-message">Loading cards from database...</div>
            </div>
        </div>
    </div>

    <!-- Card Selection Modal -->
    <div id="cardModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Select a Card</h3>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="modal-filters">
                    <div class="filter-group">
                        <label for="modalAttributeFilter">Attribute:</label>
                        <select id="modalAttributeFilter" onchange="filterModalCards()">
                            <option value="">All Attributes</option>
                            <option value="Logic">üîπ Logic</option>
                            <option value="Empathy">‚ù§Ô∏è Empathy</option>
                            <option value="Intuition">üå≤ Intuition</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="modalSearchFilter">Search by Name:</label>
                        <input type="text" id="modalSearchFilter" placeholder="Enter card name..." oninput="filterModalCards()">
                    </div>
                    <div class="filter-memory-indicator" id="filterMemoryIndicator" style="display: none; margin-left: 15px; padding: 5px 10px; background-color: #e8f5e8; border-radius: 4px; font-size: 0.8rem; color: #2e7d32;">
                        <span>üíæ Filters restored</span>
                    </div>
                </div>
                <div class="filter-status" id="modalFilterStatus" style="margin: 10px 0; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9rem; color: #666;">
                    <strong>Filter Status:</strong> <span id="filterStatusText">Showing all available cards</span>
                </div>
                <div id="modalCards" class="modal-cards-grid">
                    <!-- Cards will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allCards = [];
        let userCollection = [];
        let selectedCards = [];
        let initialGrid = Array(15).fill(null); // Initial card grid
        let newGrid = Array(15).fill(null); // New card grid
        let userGridNumbers = Array(15).fill(1); // Store number values (1-15) for initial grid
        let userGridAttributes = Array(15).fill(''); // Store attribute values for attribute planner
        let currentGridCell = null; // Track which cell is being edited
        let currentGridId = null; // Track which grid is being edited
        let gridsInitialized = false; // Track if grids have been initialized
        
        // Modal filter memory: remembers attribute and search filter selections for each grid
        // so users don't have to re-select their filters every time they open the modal
        let modalFilterMemory = {}; // Store filter values for each grid to remember selections

        // Helper function to get display name for attributes
        function getAttributeDisplayName(attribute) {
            if (!attribute) return 'None';
            const displayNames = {
                'Logic': 'üîπ Logic',
                'Empathy': '‚ù§Ô∏è Empathy',
                'Intuition': 'üå≤ Intuition'
            };
            return displayNames[attribute] || attribute;
        }

        // Initialize collection status when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateCollectionStatus();
            // Initialize grids on first load
            if (!gridsInitialized) {
                initializeGrids();
            }
        });

        // Tab functionality
        function showTab(tabName) {
            console.log('Switching to tab:', tabName, 'gridsInitialized:', gridsInitialized);
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all buttons
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load cards for create tab if it's the first time
            if (tabName === 'create' && allCards.length === 0) {
                loadAllCards();
            }
            
            // Refresh grids if it's the welcome tab (but preserve existing data)
            if (tabName === 'welcome') {
                console.log('Welcome tab selected, refreshing grids');
                refreshGrids();
                updateCollectionStatus();
            }
        }

        // Initialize the grids for the new layout
        function initializeGrids() {
            // Initialize default values for dropdowns
            userGridNumbers = Array(15).fill().map((_, i) => i + 1); // 1 to 15
            userGridAttributes = Array(15).fill(''); // Default to empty (none)
            
            createInitialGrid();
            createAttributePlanner();
            createNewGrid();
            
            gridsInitialized = true;
        }

        // Refresh grids without resetting data (for tab switching)
        function refreshGrids() {
            console.log('Refreshing grids, gridsInitialized:', gridsInitialized);
            // Only initialize if grids haven't been created yet
            if (!gridsInitialized) {
                console.log('First time loading, initializing grids with defaults');
                // First time loading, initialize with defaults
                initializeGrids();
            } else {
                console.log('Refreshing existing grids with current data');
                // Refresh existing grids with current data
                createInitialGrid();
                createAttributePlanner();
                createNewGrid();
            }
        }

        // Create a 6x5 grid (3 rows of cards + 3 rows of dropdowns)
        function createGrid(gridId, gridData, isEditable) {
            const grid = document.getElementById(gridId);
            grid.innerHTML = '';
            
            console.log(`Creating ${gridId} with 6x5 layout`);
            
            // Create 6 rows (3 for cards, 3 for dropdowns)
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = (row % 2 === 0) ? (Math.floor(row / 2) * 5 + col) : null; // Only rows 0, 2, 4 (1st, 3rd, 5th) have card indices
                    
                    if (row % 2 === 0) {
                        // Card row (rows 0, 2, 4)
                        const cell = document.createElement('div');
                        cell.className = 'grid-cell';
                        if (index !== null) {
                            cell.dataset.index = index;
                            console.log(`Creating card cell at row ${row}, col ${col} with index ${index}`);
                            
                            if (isEditable) {
                                cell.onclick = () => openCardModal(index, gridId);
                            }
                            
                            if (gridData[index]) {
                                // Display the assigned card
                                const card = gridData[index];
                                cell.innerHTML = `
                                    <div class="grid-card">
                                        <div class="grid-card-image">
                                            ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}">` : 'No Image'}
                                        </div>
                                        <div class="grid-card-name">${card.name}</div>
                                        <div class="grid-card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                                    </div>
                                `;
                            } else {
                                // Empty cell
                                cell.innerHTML = '<div class="empty-cell">+</div>';
                            }
                        } else {
                            // Empty cell for non-card positions
                            cell.innerHTML = '<div class="empty-cell">+</div>';
                        }
                        grid.appendChild(cell);
                    } else {
                        // Dropdown row (rows 1, 3, 5)
                        const dropdownContainer = document.createElement('div');
                        dropdownContainer.className = 'dropdown-container';
                        
                        if (gridId === 'userCardGrid') {
                            // Number dropdown (1-15) for first column
                            const cardIndex = Math.floor(row / 2) * 5 + col;
                            if (cardIndex < 15) {
                                console.log(`Creating number dropdown at row ${row}, col ${col} for card index ${cardIndex}`);
                                const numberDropdown = document.createElement('select');
                                numberDropdown.className = 'grid-dropdown number-dropdown';
                                numberDropdown.dataset.index = cardIndex;
                                numberDropdown.onchange = (e) => updateGridNumber(cardIndex, e.target.value);
                                
                                // Add options 1-15
                                for (let num = 1; num <= 15; num++) {
                                    const option = document.createElement('option');
                                    option.value = num;
                                    option.textContent = num;
                                    numberDropdown.appendChild(option);
                                }
                                
                                // Set current value if exists
                                if (userGridNumbers[cardIndex]) {
                                    numberDropdown.value = userGridNumbers[cardIndex];
                                }
                                
                                dropdownContainer.appendChild(numberDropdown);
                            }
                        } else {
                            // Attribute dropdown for second column
                            const cardIndex = Math.floor(row / 2) * 5 + col;
                            if (cardIndex < 15) {
                                console.log(`Creating attribute dropdown at row ${row}, col ${col} for card index ${cardIndex}`);
                                const attributeDropdown = document.createElement('select');
                                attributeDropdown.className = 'grid-dropdown attribute-dropdown';
                                attributeDropdown.dataset.index = cardIndex;
                                attributeDropdown.onchange = (e) => updateGridAttribute(cardIndex, e.target.value);
                                
                                // Add attribute options
                                const attributes = ['Logic', 'Empathy', 'Intuition'];
                                const attributeDisplayNames = {
                                    'Logic': 'üîπ Logic',
                                    'Empathy': '‚ù§Ô∏è Empathy',
                                    'Intuition': 'üå≤ Intuition'
                                };
                                attributes.forEach(attr => {
                                    const option = document.createElement('option');
                                    option.value = attr;
                                    option.textContent = attributeDisplayNames[attr];
                                    attributeDropdown.appendChild(option);
                                });
                                
                                // Set current value if exists
                                if (userGridAttributes[cardIndex]) {
                                    attributeDropdown.value = userGridAttributes[cardIndex];
                                }
                                
                                dropdownContainer.appendChild(attributeDropdown);
                            }
                        }
                        
                        grid.appendChild(dropdownContainer);
                    }
                }
            }
            
            console.log(`Grid ${gridId} created with ${grid.children.length} elements`);
        }

        // Create the initial card grid with ID selection dropdowns
        function createInitialGrid() {
            const grid = document.getElementById('initialCardGrid');
            grid.innerHTML = '';
            
            // Create 6x5 grid (3 rows of cards + 3 rows of IDs)
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = Math.floor(row / 2) * 5 + col; // Only rows 0, 2, 4 have card indices
                    
                    if (row % 2 === 0) {
                        // Card row (rows 0, 2, 4)
                        const cardCell = document.createElement('div');
                        cardCell.className = 'grid-cell';
                        cardCell.dataset.index = index;
                        cardCell.onclick = () => openCardModal(index, 'initialCardGrid');
                        
                        if (initialGrid[index]) {
                            // Display the assigned card
                            const card = initialGrid[index];
                            
                            // Apply attribute-based coloring based on the card's actual attribute
                            if (card.attribute) {
                                cardCell.classList.add(`${card.attribute.toLowerCase()}-cell`);
                                console.log(`Initial grid: Applied ${card.attribute.toLowerCase()}-cell class to position ${index} for card ${card.name}`);
                            } else {
                                cardCell.classList.remove('logic-cell', 'empathy-cell', 'intuition-cell');
                                console.log(`Initial grid: No attribute class applied to position ${index} for card ${card.name}`);
                            }
                            
                            cardCell.innerHTML = `
                                <div class="grid-card">
                                    <div class="grid-card-image">
                                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}">` : 'No Image'}
                                    </div>
                                    <div class="grid-card-name">${card.name}</div>
                                    <div class="grid-card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                                </div>
                            `;
                        } else {
                            // Empty cell
                            cardCell.innerHTML = '<div class="empty-cell">+</div>';
                        }
                        grid.appendChild(cardCell);
                    } else {
                        // ID row (rows 1, 3, 5)
                        const dropdownContainer = document.createElement('div');
                        dropdownContainer.className = 'dropdown-container';
                        
                        const numberDropdown = document.createElement('select');
                        numberDropdown.className = 'grid-dropdown number-dropdown';
                        numberDropdown.dataset.index = index;
                        numberDropdown.onchange = (e) => updateGridNumber(index, e.target.value);
                        
                        // Add options 1-15
                        for (let num = 1; num <= 15; num++) {
                            const option = document.createElement('option');
                            option.value = num;
                            option.textContent = num;
                            numberDropdown.appendChild(option);
                        }
                        
                        // Set current value if exists
                        if (userGridNumbers[index]) {
                            numberDropdown.value = userGridNumbers[index];
                        }
                        
                        dropdownContainer.appendChild(numberDropdown);
                        grid.appendChild(dropdownContainer);
                    }
                }
            }
        }

        // Create the attribute planner grid (1x15)
        function createAttributePlanner() {
            const grid = document.getElementById('attributePlanner');
            grid.innerHTML = '';
            
            // Create 1x15 grid
            for (let i = 0; i < 15; i++) {
                const cell = document.createElement('div');
                cell.className = 'attribute-planner-cell';
                
                // Show the ID number
                const idLabel = document.createElement('div');
                idLabel.className = 'id-label';
                idLabel.textContent = i + 1;
                cell.appendChild(idLabel);
                
                // Attribute dropdown
                const attributeDropdown = document.createElement('select');
                attributeDropdown.className = 'grid-dropdown attribute-dropdown';
                attributeDropdown.dataset.index = i;
                attributeDropdown.onchange = (e) => updateGridAttribute(i, e.target.value);
                
                // Add attribute options with "none" as default
                const attributes = ['', 'Logic', 'Empathy', 'Intuition'];
                const attributeDisplayNames = {
                    '': 'None',
                    'Logic': 'üîπ Logic',
                    'Empathy': '‚ù§Ô∏è Empathy',
                    'Intuition': 'üå≤ Intuition'
                };
                attributes.forEach(attr => {
                    const option = document.createElement('option');
                    option.value = attr;
                    option.textContent = attributeDisplayNames[attr];
                    attributeDropdown.appendChild(option);
                });
                
                // Set current value if exists
                if (userGridAttributes[i]) {
                    attributeDropdown.value = userGridAttributes[i];
                } else {
                    attributeDropdown.value = ''; // Default to "none"
                }
                
                // Apply attribute-based coloring to the cell
                if (userGridAttributes[i]) {
                    cell.classList.add(`${userGridAttributes[i].toLowerCase()}-cell`);
                } else {
                    // Remove all attribute classes if no attribute is selected
                    cell.classList.remove('logic-cell', 'empathy-cell', 'intuition-cell');
                }
                
                cell.appendChild(attributeDropdown);
                grid.appendChild(cell);
            }
        }

        // Create the new card grid showing IDs and attributes
        function createNewGrid() {
            const grid = document.getElementById('newCardGrid');
            grid.innerHTML = '';
            
            // Create 6x5 grid (3 rows of cards + 3 rows of info)
            for (let row = 0; row < 6; row++) {
                for (let col = 0; col < 5; col++) {
                    const index = Math.floor(row / 2) * 5 + col; // Only rows 0, 2, 4 have card indices
                    
                    if (row % 2 === 0) {
                        // Card row (rows 0, 2, 4)
                        const cardCell = document.createElement('div');
                        cardCell.className = 'grid-cell';
                        cardCell.dataset.index = index;
                        cardCell.onclick = () => openCardModal(index, 'newCardGrid');
                        
                        // Get the attribute for this position to apply coloring
                        const cardId = userGridNumbers[index];
                        const attribute = cardId && cardId >= 1 && cardId <= 15 ? userGridAttributes[cardId - 1] : null;
                        
                        // Apply attribute-based coloring to the card cell
                        if (attribute) {
                            cardCell.classList.add(`${attribute.toLowerCase()}-cell`);
                            console.log(`New grid: Applied ${attribute.toLowerCase()}-cell class to position ${index} (ID: ${cardId})`);
                        } else {
                            // Remove all attribute classes if no attribute is selected
                            cardCell.classList.remove('logic-cell', 'empathy-cell', 'intuition-cell');
                            console.log(`New grid: No attribute class applied to position ${index} (ID: ${cardId})`);
                        }
                        
                        if (newGrid[index]) {
                            // Display the assigned card
                            const card = newGrid[index];
                            cardCell.innerHTML = `
                                <div class="grid-card">
                                    <div class="grid-card-image">
                                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}">` : 'No Image'}
                                    </div>
                                    <div class="grid-card-name">${card.name}</div>
                                    <div class="grid-card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                                </div>
                            `;
                        } else {
                            // Empty cell
                            cardCell.innerHTML = '<div class="empty-cell">+</div>';
                        }
                        grid.appendChild(cardCell);
                    } else {
                        // Info row (rows 1, 3, 5)
                        const infoContainer = document.createElement('div');
                        infoContainer.className = 'info-container';
                        
                        // Show the ID that was selected in initial grid
                        const idDisplay = document.createElement('div');
                        idDisplay.className = 'id-display';
                        idDisplay.textContent = `ID: ${userGridNumbers[index] || 'N/A'}`;
                        infoContainer.appendChild(idDisplay);
                        
                        // Show the attribute from attribute planner
                        const attributeDisplay = document.createElement('div');
                        attributeDisplay.className = 'attribute-display';
                        const attribute = userGridNumbers[index] && userGridNumbers[index] >= 1 && userGridNumbers[index] <= 15 ? userGridAttributes[userGridNumbers[index] - 1] : null;
                        attributeDisplay.textContent = `Attr: ${getAttributeDisplayName(attribute)}`;
                        attributeDisplay.style.color = '#28a745';
                        infoContainer.appendChild(attributeDisplay);
                        
                        grid.appendChild(infoContainer);
                    }
                }
            }
        }

        // Open the card selection modal
        function openCardModal(cellIndex, gridId) {
            currentGridCell = cellIndex;
            currentGridId = gridId;
            document.getElementById('cardModal').style.display = 'block';
            
            // Update modal title to show which grid is being edited
            const modalTitle = document.getElementById('modalTitle');
            if (gridId === 'initialCardGrid') {
                modalTitle.textContent = `Select a Card for Initial Grid (Position ${cellIndex + 1})`;
            } else if (gridId === 'newCardGrid') {
                modalTitle.textContent = `Select a Card for New Grid (Position ${cellIndex + 1})`;
            }
            
            // Highlight the current grid being edited
            highlightCurrentGrid(gridId);
            
            // Restore previously saved filter values for this grid, or use defaults if none saved
            const savedFilters = modalFilterMemory[gridId] || { attribute: '', search: '' };
            document.getElementById('modalAttributeFilter').value = savedFilters.attribute;
            document.getElementById('modalSearchFilter').value = savedFilters.search;
            
            // Show filter memory indicator if filters were restored
            const filterMemoryIndicator = document.getElementById('filterMemoryIndicator');
            if (savedFilters.attribute || savedFilters.search) {
                filterMemoryIndicator.style.display = 'inline-block';
                // Hide the indicator after 3 seconds
                setTimeout(() => {
                    filterMemoryIndicator.style.display = 'none';
                }, 3000);
            } else {
                filterMemoryIndicator.style.display = 'none';
            }
            
            console.log(`Modal opened for ${gridId}, restored filters:`, savedFilters);
            
            loadModalCards();
        }

        // Close the modal
        function closeModal() {
            // Save current filter values before closing (in case they were changed but not filtered)
            if (currentGridId) {
                const attributeFilter = document.getElementById('modalAttributeFilter').value;
                const searchFilter = document.getElementById('modalSearchFilter').value;
                modalFilterMemory[currentGridId] = {
                    attribute: attributeFilter,
                    search: searchFilter
                };
            }
            
            // Hide the filter memory indicator
            const filterMemoryIndicator = document.getElementById('filterMemoryIndicator');
            if (filterMemoryIndicator) {
                filterMemoryIndicator.style.display = 'none';
            }
            
            document.getElementById('cardModal').style.display = 'none';
            currentGridCell = null;
            currentGridId = null;
            
            // Remove highlighting from all grids
            const initialGridElement = document.getElementById('initialCardGrid');
            const attributePlannerElement = document.getElementById('attributePlanner');
            const newGridElement = document.getElementById('newCardGrid');
            
            if (initialGridElement) {
                initialGridElement.style.border = '2px solid transparent';
                initialGridElement.style.boxShadow = 'none';
            }
            if (attributePlannerElement) {
                attributePlannerElement.style.border = '2px solid transparent';
                attributePlannerElement.style.boxShadow = 'none';
            }
            if (newGridElement) {
                newGridElement.style.border = '2px solid transparent';
                newGridElement.style.boxShadow = 'none';
            }
        }

        // Load cards in the modal
        function loadModalCards() {
            // In the welcome tab, only show cards from user's loaded collection
            if (currentGridCell !== null && currentGridId !== null) {
                if (userCollection.length === 0) {
                    // No collection loaded, show message
                    const container = document.getElementById('modalCards');
                    container.innerHTML = '<div class="no-cards-message">Please load your card collection first in the "Card Collection" tab.</div>';
                    // Update filter status to show no cards available
                    updateModalFilterStatus('', '', 0, 0);
                    return;
                }
                
                // Apply current filters when opening the modal
                filterModalCards();
            } else {
                // Fallback to all cards (shouldn't happen in normal flow)
                if (allCards.length === 0) {
                    // Try to load from CSV if not already loaded
                    loadAllCards().then(() => {
                        filterModalCards();
                    });
                } else {
                    filterModalCards();
                }
            }
        }

        // Display cards in the modal
        function displayModalCards(cards) {
            const container = document.getElementById('modalCards');
            
            // Only filter out cards that are already in the current grid being edited
            let availableCards = cards;
            if (currentGridId === 'initialCardGrid') {
                availableCards = cards.filter(card => {
                    return !initialGrid.some(gridCard => gridCard && gridCard.name === card.name);
                });
            } else if (currentGridId === 'newCardGrid') {
                availableCards = cards.filter(card => {
                    return !newGrid.some(gridCard => gridCard && gridCard.name === card.name);
                });
            }
            
            if (availableCards.length === 0) {
                const gridName = currentGridId === 'initialCardGrid' ? 'Initial Grid' : 'New Grid';
                container.innerHTML = `<div class="no-cards-message">No available cards. All cards are already in the ${gridName}.</div>`;
                return;
            }

            // Sort by rarity then by name
            const sortedCards = availableCards.sort((a, b) => {
                const rarityOrder = { 'SSS icon': 1, 'SSR icon': 2, 'SR icon': 3, 'R icon': 4, 'N icon': 5 };
                const aRarity = rarityOrder[a.rarity] || 6;
                const bRarity = rarityOrder[b.rarity] || 6;
                
                if (aRarity !== bRarity) {
                    return aRarity - bRarity;
                }
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = sortedCards.map(card => `
                <div class="modal-card-item" onclick="selectCardForGrid('${card.name}')">
                    <div class="rarity-badge">${card.rarity.replace(' icon', '')}</div>
                    <div class="modal-card-image">
                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}">` : 'No Image'}
                    </div>
                    <div class="modal-card-name">${card.name}</div>
                    <div class="modal-card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                </div>
            `).join('');
        }

        // Filter cards in the modal
        function filterModalCards() {
            const attributeFilter = document.getElementById('modalAttributeFilter').value;
            const searchFilter = document.getElementById('modalSearchFilter').value.toLowerCase();
            
            // Save the current filter values for the current grid to remember them
            if (currentGridId) {
                modalFilterMemory[currentGridId] = {
                    attribute: attributeFilter,
                    search: document.getElementById('modalSearchFilter').value // Save the original value, not lowercase
                };
                console.log(`Saved filters for ${currentGridId}:`, modalFilterMemory[currentGridId]);
            }
            
            // Use userCollection instead of allCards for filtering in the welcome tab
            const cardsToFilter = currentGridCell !== null ? userCollection : allCards;
            
            console.log('Filtering modal cards:', {
                attributeFilter,
                searchFilter,
                totalCards: cardsToFilter.length,
                currentGridCell,
                currentGridId
            });
            
            const filtered = cardsToFilter.filter(card => {
                const matchesAttribute = !attributeFilter || card.attribute === attributeFilter;
                const matchesSearch = !searchFilter || card.name.toLowerCase().includes(searchFilter);
                
                // Only check if card is already in the current grid being edited
                let notInCurrentGrid = true;
                if (currentGridId === 'initialCardGrid') {
                    notInCurrentGrid = !initialGrid.some(gridCard => gridCard && gridCard.name === card.name);
                } else if (currentGridId === 'newCardGrid') {
                    notInCurrentGrid = !newGrid.some(gridCard => gridCard && gridCard.name === card.name);
                }
                
                console.log(`Card ${card.name}: attribute=${card.attribute}, matchesAttribute=${matchesAttribute}, matchesSearch=${matchesSearch}, notInCurrentGrid=${notInCurrentGrid}, currentGrid=${currentGridId}`);
                
                return matchesAttribute && matchesSearch && notInCurrentGrid;
            });
            
            console.log(`Filtered ${filtered.length} cards out of ${cardsToFilter.length}`);
            
            // Update filter status display
            updateModalFilterStatus(attributeFilter, searchFilter, filtered.length, cardsToFilter.length);
            
            displayModalCards(filtered);
        }

        // Select a card for the grid
        function selectCardForGrid(cardName) {
            // Find card from user's collection first, then fallback to all cards
            let card = userCollection.find(c => c.name === cardName);
            if (!card) {
                card = allCards.find(c => c.name === cardName);
            }
            
            if (card && currentGridCell !== null && currentGridId !== null) {
                console.log(`Adding card ${cardName} to ${currentGridId} at position ${currentGridCell}`);
                // Add card to the appropriate grid
                if (currentGridId === 'initialCardGrid') {
                    initialGrid[currentGridCell] = card;
                    console.log('Updated initialGrid:', initialGrid);
                    createInitialGrid();
                } else if (currentGridId === 'newCardGrid') {
                    newGrid[currentGridCell] = card;
                    console.log('Updated newGrid:', newGrid);
                    createNewGrid();
                }
                closeModal();
            }
        }

        // Update number value for grid cell
        function updateGridNumber(index, value) {
            userGridNumbers[index] = parseInt(value);
            console.log(`Grid ${index} number updated to: ${value}`);
            console.log('Updated userGridNumbers:', userGridNumbers);
            // Refresh the new grid to show updated ID and attribute info
            createNewGrid();
        }

        // Update attribute value for grid cell
        function updateGridAttribute(index, value) {
            userGridAttributes[index] = value;
            console.log(`Grid ${index} attribute updated to: ${value}`);
            console.log('Updated userGridAttributes:', userGridAttributes);
            // Refresh both grids to show updated attribute info and coloring
            createAttributePlanner();
            createNewGrid();
        }

        // Highlight the current grid being edited
        function highlightCurrentGrid(gridId) {
            // Remove highlight from all grids
            const initialGridElement = document.getElementById('initialCardGrid');
            const attributePlannerElement = document.getElementById('attributePlanner');
            const newGridElement = document.getElementById('newCardGrid');
            
            if (initialGridElement) {
                initialGridElement.style.border = '2px solid transparent';
                initialGridElement.style.boxShadow = 'none';
            }
            if (attributePlannerElement) {
                attributePlannerElement.style.border = '2px solid transparent';
                attributePlannerElement.style.boxShadow = 'none';
            }
            if (newGridElement) {
                newGridElement.style.border = '2px solid transparent';
                newGridElement.style.boxShadow = 'none';
            }
            
            // Highlight the current grid
            if (gridId === 'initialCardGrid' && initialGridElement) {
                initialGridElement.style.border = '2px solid #667eea';
                initialGridElement.style.boxShadow = '0 0 10px rgba(102, 126, 234, 0.3)';
            } else if (gridId === 'newCardGrid' && newGridElement) {
                newGridElement.style.border = '2px solid #007bff';
                newGridElement.style.boxShadow = '0 0 10px rgba(0, 123, 255, 0.3)';
            }
        }

        // Update modal filter status display
        function updateModalFilterStatus(attributeFilter, searchFilter, filteredCount, totalCount) {
            const statusText = document.getElementById('filterStatusText');
            const filterStatus = document.getElementById('modalFilterStatus');
            
            const gridName = currentGridId === 'initialCardGrid' ? 'Initial Grid' : 'New Grid';
            
            let statusMessage = '';
            let statusColor = '#f8f9fa';
            let textColor = '#666';
            
            if (attributeFilter && searchFilter) {
                statusMessage = `Showing ${filteredCount} of ${totalCount} cards for ${gridName} (filtered by "${attributeFilter}" attribute and "${searchFilter}" search)`;
                statusColor = '#e3f2fd';
                textColor = '#1976d2';
            } else if (attributeFilter) {
                statusMessage = `Showing ${filteredCount} of ${totalCount} cards for ${gridName} (filtered by "${attributeFilter}" attribute)`;
                statusColor = '#e8f5e8';
                textColor = '#2e7d32';
            } else if (searchFilter) {
                statusMessage = `Showing ${filteredCount} of ${totalCount} cards for ${gridName} (filtered by "${searchFilter}" search)`;
                statusColor = '#fff3e0';
                textColor = '#f57c00';
            } else {
                statusMessage = `Showing ${filteredCount} of ${totalCount} available cards for ${gridName}`;
                statusColor = '#f8f9fa';
                textColor = '#666';
            }
            
            statusText.textContent = statusMessage;
            filterStatus.style.backgroundColor = statusColor;
            filterStatus.style.color = textColor;
        }

        // Export grid configuration
        function exportGridConfig() {
            const gridConfig = {
                initialGrid: initialGrid,
                newGrid: newGrid,
                numbers: userGridNumbers,
                attributes: userGridAttributes,
                modalFilterMemory: modalFilterMemory, // Include filter memory in export
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(gridConfig, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'grid_configuration.json';
            link.click();
        }

        // Clear filter memory
        function clearFilterMemory() {
            if (confirm('Are you sure you want to clear all saved filter preferences? This will reset attribute and search filters to default values when you next open the modal.')) {
                modalFilterMemory = {};
                console.log('Filter memory cleared');
                alert('Filter memory cleared successfully!');
            }
        }
        
        // Debug function to show current filter memory (can be called from console)
        function showFilterMemory() {
            console.log('Current filter memory:', modalFilterMemory);
            if (Object.keys(modalFilterMemory).length === 0) {
                console.log('No filters saved yet');
            } else {
                Object.entries(modalFilterMemory).forEach(([gridId, filters]) => {
                    console.log(`${gridId}:`, filters);
                });
            }
        }

        // Load grid configuration
        function loadGridConfig() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const config = JSON.parse(e.target.result);
                            if (config.initialGrid && config.newGrid && config.numbers && config.attributes) {
                                initialGrid = config.initialGrid;
                                newGrid = config.newGrid;
                                userGridNumbers = config.numbers;
                                userGridAttributes = config.attributes;
                                // Restore filter memory if available
                                if (config.modalFilterMemory) {
                                    modalFilterMemory = config.modalFilterMemory;
                                    console.log('Restored filter memory:', modalFilterMemory);
                                }
                                createInitialGrid();
                                createAttributePlanner();
                                createNewGrid();
                                gridsInitialized = true;
                                alert('Grid configuration loaded successfully!');
                            } else if (config.cards && config.numbers && config.attributes) {
                                // Handle old format for backward compatibility
                                initialGrid = config.cards;
                                userGridNumbers = config.numbers;
                                userGridAttributes = config.attributes;
                                // Restore filter memory if available (even in legacy format)
                                if (config.modalFilterMemory) {
                                    modalFilterMemory = config.modalFilterMemory;
                                    console.log('Restored filter memory from legacy format:', modalFilterMemory);
                                }
                                createInitialGrid();
                                createAttributePlanner();
                                createNewGrid();
                                gridsInitialized = true;
                                alert('Grid configuration loaded successfully! (Legacy format)');
                            } else {
                                alert('Invalid grid configuration file.');
                            }
                        } catch (error) {
                            alert('Error reading configuration file.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('cardModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load all cards from CSV
        async function loadAllCards() {
            try {
                const response = await fetch('data/tot_cards_with_icons.csv');
                const csvText = await response.text();
                const lines = csvText.split('\n');
                const headers = lines[0].split(',');
                
                allCards = [];
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        const card = {
                            name: values[0],
                            character: values[1],
                            rarity: values[2],
                            attribute: values[3],
                            iconUrl: values[4],
                            localPath: values[5]
                        };
                        allCards.push(card);
                    }
                }
                
                displayCreateCards(allCards);
            } catch (error) {
                console.error('Error loading cards:', error);
                document.getElementById('createCards').innerHTML = '<div class="no-cards-message">Error loading cards. Please check if the CSV file  sts.</div>';
            }
        }

        // Display cards in create tab
        function displayCreateCards(cards) {
            const container = document.getElementById('createCards');
            if (cards.length === 0) {
                container.innerHTML = '<div class="no-cards-message">No cards found matching your criteria.</div>';
                return;
            }

            // Sort by rarity then by name
            const sortedCards = cards.sort((a, b) => {
                const rarityOrder = { 'SSS icon': 1, 'SSR icon': 2, 'SR icon': 3, 'R icon': 4, 'N icon': 5 };
                const aRarity = rarityOrder[a.rarity] || 6;
                const bRarity = rarityOrder[b.rarity] || 6;
                
                if (aRarity !== bRarity) {
                    return aRarity - bRarity;
                }
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = sortedCards.map(card => `
                <div class="card-item">
                    <div class="rarity-badge">${card.rarity.replace(' icon', '')}</div>
                    <div class="card-image">
                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 'No Image'}
                    </div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                    <button class="add-card-btn" onclick="addCardToCollection('${card.name}')" title="Add to collection">+</button>
                </div>
            `).join('');
        }

        // Filter cards in create tab
        function filterCreateCards() {
            const attributeFilter = document.getElementById('createAttributeFilter').value;
            const searchFilter = document.getElementById('createSearchFilter').value.toLowerCase();
            
            const filtered = allCards.filter(card => {
                const matchesAttribute = !attributeFilter || card.attribute === attributeFilter;
                const matchesSearch = !searchFilter || card.name.toLowerCase().includes(searchFilter);
                return matchesAttribute && matchesSearch;
            });
            
            displayCreateCards(filtered);
        }

        // Add card to collection
        function addCardToCollection(cardName) {
            const card = allCards.find(c => c.name === cardName);
            if (card && !selectedCards.find(c => c.name === cardName)) {
                selectedCards.push(card);
                displaySelectedCards();
            }
        }

        // Remove card from collection
        function removeCardFromCollection(cardName) {
            selectedCards = selectedCards.filter(c => c.name !== cardName);
            displaySelectedCards();
        }

        // Display selected cards
        function displaySelectedCards() {
            const container = document.getElementById('selectedCards');
            if (selectedCards.length === 0) {
                container.innerHTML = '<div class="no-cards-message">No cards selected yet. Click the + button on cards to add them to your collection.</div>';
                return;
            }

            // Sort by rarity then by name
            const sortedCards = selectedCards.sort((a, b) => {
                const rarityOrder = { 'SSS icon': 1, 'SSR icon': 2, 'SR icon': 3, 'R icon': 4, 'N icon': 5 };
                const aRarity = rarityOrder[a.rarity] || 6;
                const bRarity = rarityOrder[b.rarity] || 6;
                
                if (aRarity !== bRarity) {
                    return aRarity - bRarity;
                }
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = sortedCards.map(card => `
                <div class="card-item">
                    <div class="rarity-badge">${card.rarity.replace(' icon', '')}</div>
                    <div class="card-image">
                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 'No Image'}
                    </div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                    <button class="add-card-btn" onclick="removeCardFromCollection('${card.name}')" title="Remove from collection" style="background: #dc3545;">-</button>
                </div>
            `).join('');
        }

        // Load user collection
        function loadCollection() {
            const fileInput = document.getElementById('collectionFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a file first.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    userCollection = JSON.parse(e.target.result);
                    filterCards();
                    updateCollectionStatus();
                } catch (error) {
                    alert('Error reading file. Please make sure it\'s a valid JSON file.');
                }
            };
            reader.readAsText(file);
        }

        // Filter cards in collection tab
        function filterCards() {
            const attributeFilterElement = document.getElementById('attributeFilter');
            const attributeFilter = attributeFilterElement.value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            
            const filtered = userCollection.filter(card => {
                const matchesAttribute = !attributeFilter || card.attribute === attributeFilter;
                const matchesSearch = !searchFilter || card.name.toLowerCase().includes(searchFilter);
                return matchesAttribute && matchesSearch;
            });
            
            displayCollectionCards(filtered);
        }

        // Display collection cards
        function displayCollectionCards(cards) {
            const container = document.getElementById('collectionCards');
            if (cards.length === 0) {
                container.innerHTML = '<div class="no-cards-message">No cards found matching your criteria.</div>';
                return;
            }

            // Sort by rarity then by name
            const sortedCards = cards.sort((a, b) => {
                const rarityOrder = { 'SSS icon': 1, 'SSR icon': 2, 'SR icon': 3, 'R icon': 4, 'N icon': 5 };
                const aRarity = rarityOrder[a.rarity] || 6;
                const bRarity = rarityOrder[b.rarity] || 6;
                
                if (aRarity !== bRarity) {
                    return aRarity - bRarity;
                }
                return a.name.localeCompare(b.name);
            });

            container.innerHTML = sortedCards.map(card => `
                <div class="card-item">
                    <div class="rarity-badge">${card.rarity.replace(' icon', '')}</div>
                    <div class="card-image">
                        ${card.localPath ? `<img src="${card.localPath}" alt="${card.name}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">` : 'No Image'}
                    </div>
                    <div class="card-name">${card.name}</div>
                    <div class="card-attribute attribute-${card.attribute.toLowerCase()}">${getAttributeDisplayName(card.attribute)}</div>
                </div>
            `).join('');
        }

        // Update collection status display
        function updateCollectionStatus() {
            const statusText = document.getElementById('statusText');
            const collectionStatus = document.getElementById('collectionStatus');
            
            if (userCollection.length > 0) {
                statusText.textContent = `${userCollection.length} cards loaded`;
                collectionStatus.style.backgroundColor = '#d4edda';
                collectionStatus.style.borderColor = '#c3e6cb';
                collectionStatus.style.color = '#155724';
            } else {
                statusText.textContent = 'No collection loaded';
                collectionStatus.style.backgroundColor = '#f8f9fa';
                collectionStatus.style.borderColor = '#dee2e6';
                collectionStatus.style.color = '#6c757d';
            }
        }

        // Download collection
        function downloadCollection() {
            if (selectedCards.length === 0) {
                alert('Please select at least one card before creating a collection.');
                return;
            }

            const dataStr = JSON.stringify(selectedCards, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = 'card_collection.json';
            link.click();
        }
    </script>
</body>
</html>
